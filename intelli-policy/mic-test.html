<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº¦å…‹é£è¯Šæ–­å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-bottom: 30px; text-align: center; }
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        .test-section h2 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.testing { background: #fff3cd; color: #856404; }
        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .volume-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
        }
        .volume-level {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            width: 0%;
            transition: width 0.1s;
        }
        .log {
            background: #212529;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .result-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            min-height: 80px;
        }
        .result-text {
            font-size: 18px;
            color: #495057;
            line-height: 1.6;
        }
        .tip {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .tip-title {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 5px;
        }
        canvas {
            width: 100%;
            height: 60px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” éº¦å…‹é£ & è¯­éŸ³è¯†åˆ«è¯Šæ–­å·¥å…·</h1>

        <!-- æµ‹è¯•1: éº¦å…‹é£æƒé™ -->
        <div class="test-section">
            <h2>
                <span id="test1-icon">â¸ï¸</span>
                æµ‹è¯•1: éº¦å…‹é£æƒé™æ£€æµ‹
            </h2>
            <button class="btn-primary" onclick="testMicPermission()">å¼€å§‹æµ‹è¯•</button>
            <div id="test1-status"></div>
        </div>

        <!-- æµ‹è¯•2: éŸ³é‡æ£€æµ‹ -->
        <div class="test-section">
            <h2>
                <span id="test2-icon">â¸ï¸</span>
                æµ‹è¯•2: éŸ³é‡æ£€æµ‹ï¼ˆè¯´è¯æ—¶éŸ³é‡æ¡åº”è¯¥æœ‰å˜åŒ–ï¼‰
            </h2>
            <button class="btn-primary" onclick="testVolume()">å¼€å§‹éŸ³é‡æ£€æµ‹</button>
            <button class="btn-danger" onclick="stopVolume()" style="display:none;" id="stopVolumeBtn">åœæ­¢æ£€æµ‹</button>
            <div class="volume-bar">
                <div class="volume-level" id="volumeLevel"></div>
            </div>
            <canvas id="waveform"></canvas>
            <div id="test2-status"></div>
        </div>

        <!-- æµ‹è¯•3: æµè§ˆå™¨æ”¯æŒ -->
        <div class="test-section">
            <h2>
                <span id="test3-icon">â¸ï¸</span>
                æµ‹è¯•3: Web Speech API æ”¯æŒæ£€æµ‹
            </h2>
            <button class="btn-primary" onclick="testSpeechAPI()">å¼€å§‹æµ‹è¯•</button>
            <div id="test3-status"></div>
        </div>

        <!-- æµ‹è¯•4: å®Œæ•´è¯­éŸ³è¯†åˆ« -->
        <div class="test-section">
            <h2>
                <span id="test4-icon">â¸ï¸</span>
                æµ‹è¯•4: å®Œæ•´è¯­éŸ³è¯†åˆ«æµ‹è¯•
            </h2>
            <div class="tip">
                <div class="tip-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</div>
                1. ç‚¹å‡»"å¼€å§‹è¯­éŸ³è¯†åˆ«"<br>
                2. å…è®¸éº¦å…‹é£æƒé™<br>
                3. æ¸…æ™°è¯´è¯ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½"<br>
                4. <strong>è¯´å®Œåä¿æŒå®‰é™ï¼Œç­‰å¾… 2-3 ç§’</strong><br>
                5. ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ˜¾ç¤ºç»“æœ
            </div>
            <button class="btn-primary" onclick="testSpeechRecognition()">å¼€å§‹è¯­éŸ³è¯†åˆ«</button>
            <div class="result-box">
                <div class="result-text" id="speechResult">ç­‰å¾…å¼€å§‹...</div>
            </div>
            <div id="test4-status"></div>
            <div class="log" id="speechLog">
                <div>[ç³»ç»Ÿ] ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>

        <!-- è¯Šæ–­ç»“æœ -->
        <div class="test-section" id="diagnosis" style="display:none;">
            <h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>
            <div id="diagnosisContent"></div>
        </div>
    </div>

    <script>
        let audioContext = null;
        let mediaStream = null;
        let analyser = null;
        let animationId = null;
        let recognition = null;

        function log(message, elementId = 'speechLog') {
            const logEl = document.getElementById(elementId);
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // æµ‹è¯•1: éº¦å…‹é£æƒé™
        async function testMicPermission() {
            const statusEl = document.getElementById('test1-status');
            const iconEl = document.getElementById('test1-icon');
            
            try {
                statusEl.innerHTML = '<span class="status testing">æµ‹è¯•ä¸­...</span>';
                iconEl.textContent = 'â³';
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // æ£€æµ‹éŸ³è½¨
                const tracks = stream.getAudioTracks();
                console.log('éŸ³è½¨ä¿¡æ¯:', tracks);
                
                if (tracks.length > 0) {
                    const track = tracks[0];
                    const settings = track.getSettings();
                    
                    statusEl.innerHTML = `
                        <span class="status pass">âœ… éº¦å…‹é£æƒé™æ­£å¸¸</span>
                        <div style="margin-top:10px; font-size:14px; color:#495057;">
                            è®¾å¤‡: ${track.label || 'é»˜è®¤éº¦å…‹é£'}<br>
                            é‡‡æ ·ç‡: ${settings.sampleRate || 'N/A'} Hz<br>
                            å£°é“æ•°: ${settings.channelCount || 'N/A'}
                        </div>
                    `;
                    iconEl.textContent = 'âœ…';
                } else {
                    throw new Error('æœªæ£€æµ‹åˆ°éŸ³è½¨');
                }
                
                // åœæ­¢æµ
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                statusEl.innerHTML = `
                    <span class="status fail">âŒ éº¦å…‹é£æƒé™å¤±è´¥</span>
                    <div style="margin-top:10px; color:#721c24;">
                        é”™è¯¯: ${error.message}<br>
                        <strong>è§£å†³æ–¹æ³•:</strong><br>
                        1. æ£€æŸ¥æµè§ˆå™¨åœ°å€æ æ˜¯å¦æœ‰ğŸ”’å›¾æ ‡ï¼Œç‚¹å‡»æˆæƒéº¦å…‹é£<br>
                        2. æ£€æŸ¥ç³»ç»Ÿè®¾ç½®ä¸­éº¦å…‹é£æ˜¯å¦è¢«ç¦ç”¨<br>
                        3. å°è¯•ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨
                    </div>
                `;
                iconEl.textContent = 'âŒ';
                console.error('éº¦å…‹é£æƒé™é”™è¯¯:', error);
            }
        }

        // æµ‹è¯•2: éŸ³é‡æ£€æµ‹
        async function testVolume() {
            const statusEl = document.getElementById('test2-status');
            const iconEl = document.getElementById('test2-icon');
            const volumeLevel = document.getElementById('volumeLevel');
            const canvas = document.getElementById('waveform');
            const ctx = canvas.getContext('2d');
            const stopBtn = document.getElementById('stopVolumeBtn');
            
            try {
                statusEl.innerHTML = '<span class="status testing">æ­£åœ¨æ£€æµ‹ï¼Œè¯·è¯´è¯...</span>';
                iconEl.textContent = 'ğŸ¤';
                stopBtn.style.display = 'inline-block';
                
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(mediaStream);
                source.connect(analyser);
                
                analyser.fftSize = 2048;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                let maxVolume = 0;
                let hasSound = false;
                
                function draw() {
                    animationId = requestAnimationFrame(draw);
                    
                    analyser.getByteTimeDomainData(dataArray);
                    
                    // è®¡ç®—éŸ³é‡
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        const value = (dataArray[i] - 128) / 128;
                        sum += value * value;
                    }
                    const volume = Math.sqrt(sum / bufferLength) * 100;
                    
                    maxVolume = Math.max(maxVolume, volume);
                    if (volume > 5) hasSound = true;
                    
                    // æ›´æ–°éŸ³é‡æ¡
                    volumeLevel.style.width = volume + '%';
                    
                    // ç»˜åˆ¶æ³¢å½¢
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    ctx.fillStyle = '#f8f9fa';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#667eea';
                    ctx.beginPath();
                    
                    const sliceWidth = canvas.width / bufferLength;
                    let x = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * canvas.height / 2;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                        
                        x += sliceWidth;
                    }
                    
                    ctx.lineTo(canvas.width, canvas.height / 2);
                    ctx.stroke();
                    
                    // æ›´æ–°çŠ¶æ€
                    if (hasSound) {
                        statusEl.innerHTML = `
                            <span class="status pass">âœ… æ£€æµ‹åˆ°å£°éŸ³ï¼</span>
                            <div style="margin-top:10px; font-size:14px; color:#495057;">
                                å½“å‰éŸ³é‡: ${volume.toFixed(1)}%<br>
                                æœ€å¤§éŸ³é‡: ${maxVolume.toFixed(1)}%
                            </div>
                        `;
                        iconEl.textContent = 'âœ…';
                    }
                }
                
                draw();
                
            } catch (error) {
                statusEl.innerHTML = `<span class="status fail">âŒ éŸ³é‡æ£€æµ‹å¤±è´¥: ${error.message}</span>`;
                iconEl.textContent = 'âŒ';
                console.error('éŸ³é‡æ£€æµ‹é”™è¯¯:', error);
            }
        }

        function stopVolume() {
            if (animationId) cancelAnimationFrame(animationId);
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
            if (audioContext) audioContext.close();
            document.getElementById('stopVolumeBtn').style.display = 'none';
            document.getElementById('volumeLevel').style.width = '0%';
        }

        // æµ‹è¯•3: Web Speech API
        function testSpeechAPI() {
            const statusEl = document.getElementById('test3-status');
            const iconEl = document.getElementById('test3-icon');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                statusEl.innerHTML = `
                    <span class="status pass">âœ… æµè§ˆå™¨æ”¯æŒ Web Speech API</span>
                    <div style="margin-top:10px; font-size:14px; color:#495057;">
                        API: ${window.SpeechRecognition ? 'SpeechRecognition' : 'webkitSpeechRecognition'}<br>
                        æµè§ˆå™¨: ${navigator.userAgent.match(/(Chrome|Edge|Firefox|Safari)\/[\d.]+/)?.[0] || 'Unknown'}
                    </div>
                `;
                iconEl.textContent = 'âœ…';
            } else {
                statusEl.innerHTML = `
                    <span class="status fail">âŒ æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API</span>
                    <div style="margin-top:10px; color:#721c24;">
                        <strong>è¯·ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨:</strong><br>
                        â€¢ Google Chrome (æ¨è)<br>
                        â€¢ Microsoft Edge<br>
                        â€¢ å…¶ä»–åŸºäº Chromium çš„æµè§ˆå™¨
                    </div>
                `;
                iconEl.textContent = 'âŒ';
            }
        }

        // æµ‹è¯•4: å®Œæ•´è¯­éŸ³è¯†åˆ«
        function testSpeechRecognition() {
            const statusEl = document.getElementById('test4-status');
            const iconEl = document.getElementById('test4-icon');
            const resultEl = document.getElementById('speechResult');
            
            log('[ç³»ç»Ÿ] åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«...');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                statusEl.innerHTML = '<span class="status fail">âŒ æµè§ˆå™¨ä¸æ”¯æŒ</span>';
                log('[é”™è¯¯] æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API');
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';
            recognition.maxAlternatives = 3;
            
            log(`[é…ç½®] continuous=false, interimResults=true, lang=zh-CN, maxAlternatives=3`);
            
            recognition.onstart = () => {
                log('[äº‹ä»¶] è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨ âœ…');
                statusEl.innerHTML = '<span class="status testing">ğŸ¤ æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...</span>';
                iconEl.textContent = 'ğŸ¤';
                resultEl.textContent = 'æ­£åœ¨è†å¬...';
                resultEl.style.color = '#856404';
            };
            
            recognition.onresult = (event) => {
                log(`[äº‹ä»¶] æ”¶åˆ°è¯†åˆ«ç»“æœï¼Œå…± ${event.results.length} ä¸ªç»“æœ`);
                
                for (let i = 0; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    const confidence = (result[0].confidence * 100).toFixed(2);
                    const isFinal = result.isFinal;
                    
                    log(`[ç»“æœ${i+1}] "${transcript}" (æœ€ç»ˆ:${isFinal}, ç½®ä¿¡åº¦:${confidence}%)`);
                    
                    if (isFinal) {
                        resultEl.textContent = transcript;
                        resultEl.style.color = '#155724';
                        statusEl.innerHTML = `<span class="status pass">âœ… è¯†åˆ«æˆåŠŸï¼ç½®ä¿¡åº¦: ${confidence}%</span>`;
                        iconEl.textContent = 'âœ…';
                        
                        // æ˜¾ç¤ºæ‰€æœ‰å€™é€‰ç»“æœ
                        if (result.length > 1) {
                            log('[å€™é€‰] å…¶ä»–å¯èƒ½çš„ç»“æœ:');
                            for (let j = 1; j < result.length; j++) {
                                log(`  ${j+1}. "${result[j].transcript}" (${(result[j].confidence * 100).toFixed(2)}%)`);
                            }
                        }
                    } else {
                        resultEl.textContent = transcript + ' (è¯†åˆ«ä¸­...)';
                        resultEl.style.color = '#856404';
                    }
                }
            };
            
            recognition.onerror = (event) => {
                log(`[é”™è¯¯] ${event.error}`, 'speechLog');
                statusEl.innerHTML = `<span class="status fail">âŒ é”™è¯¯: ${event.error}</span>`;
                iconEl.textContent = 'âŒ';
                resultEl.textContent = 'è¯†åˆ«å¤±è´¥';
                resultEl.style.color = '#721c24';
                
                const errorMessages = {
                    'no-speech': 'âŒ æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ - è¯·ç¡®ä¿éº¦å…‹é£æ­£å¸¸å·¥ä½œå¹¶ä¸”ç¯å¢ƒä¸è¦å¤ªå®‰é™',
                    'audio-capture': 'âŒ æ— æ³•æ•è·éŸ³é¢‘ - è¯·æ£€æŸ¥éº¦å…‹é£è¿æ¥',
                    'not-allowed': 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç» - è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®',
                    'network': 'âŒ ç½‘ç»œé”™è¯¯ - è¯­éŸ³è¯†åˆ«éœ€è¦ç½‘ç»œè¿æ¥',
                    'aborted': 'âš ï¸ è¯†åˆ«è¢«ä¸­æ­¢',
                    'service-not-allowed': 'âŒ æœåŠ¡ä¸å¯ç”¨ - å¯èƒ½æ˜¯æµè§ˆå™¨é™åˆ¶'
                };
                
                if (errorMessages[event.error]) {
                    log(errorMessages[event.error]);
                }
            };
            
            recognition.onend = () => {
                log('[äº‹ä»¶] è¯­éŸ³è¯†åˆ«å·²ç»“æŸ');
                if (iconEl.textContent === 'ğŸ¤') {
                    statusEl.innerHTML = '<span class="status fail">âš ï¸ æœªèƒ½è¯†åˆ«åˆ°å†…å®¹</span>';
                    iconEl.textContent = 'âš ï¸';
                }
            };
            
            try {
                log('[æ“ä½œ] å¯åŠ¨è¯†åˆ«...');
                recognition.start();
            } catch (error) {
                log(`[é”™è¯¯] å¯åŠ¨å¤±è´¥: ${error.message}`);
                statusEl.innerHTML = `<span class="status fail">âŒ å¯åŠ¨å¤±è´¥: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
